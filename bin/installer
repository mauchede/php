#!/bin/sh
set -x

fail() {
    echo $1 1>&2
    echo "Usage: $0 [install|uninstall]" 1>&2
    exit 1
}

install() {
    docker run \
        -v /:/host \
        --entrypoint=/bin/sh \
        --rm \
        ${IMAGE:-mauchede/php}:${TAG:-5.5.35} -c "cp $1 /host/$1"
}

[ $# -lt 1 ] && fail "Invalid number of arguments"
[ $(id -u) != 0 ] && fail "Impossible to prepare the system without root privileges."
[ $(uname) != Linux ] && fail "Impossible to prepare another operating system than Linux."

case $1 in
    install )
        curl -sLo /usr/local/bin/php "https://github.com/mauchede/php/raw/master/bin/php"
        chmod +x /usr/local/bin/php

        mkdir -p /etc/php/conf.d

        install /etc/php/conf.d/00_bz2.ini
        install /etc/php/conf.d/00_gd.ini
        install /etc/php/conf.d/00_intl.ini
        install /etc/php/conf.d/00_mysql.ini
        install /etc/php/conf.d/00_opcache.ini
        install /etc/php/conf.d/00_pdo_mysql.ini
        install /etc/php/conf.d/00_pgsql.ini
        install /etc/php/conf.d/00_pgsql.ini
        install /etc/php/conf.d/00_zip.ini

        > /etc/php/conf.d/10_default.ini
        echo "date.timezone = $(cat /etc/timezone)" >> /etc/php/conf.d/10_default.ini
    ;;

    uninstall )
        rm -rf /etc/php
        rm /usr/local/bin/php
    ;;

    * )
        fail "Argument $1 is invalid."
esac
